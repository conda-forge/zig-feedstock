# Linux: Link pthread_atfork stub into zig2 executable
#
# glibc 2.28 on some architectures (x86_64, aarch64, ppc64le) doesn't
# export pthread_atfork symbol. Zig's crypto.tlcsprng module needs this
# symbol, so we link a stub implementation.
#
# The stub is created in ZIG_LOCAL_CACHE_DIR/pthread_atfork_stub.o
# during the build script execution.

--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -881,4 +881,16 @@ target_link_libraries(zig2
 target_link_libraries(zig2 LINK_PUBLIC zigcpp)
 
+# Link pthread_atfork stub if it exists (needed for glibc 2.28)
+message(STATUS "DEBUG: ZIG_LOCAL_CACHE_DIR env var = '$ENV{ZIG_LOCAL_CACHE_DIR}'")
+set(PTHREAD_STUB "$ENV{ZIG_LOCAL_CACHE_DIR}/pthread_atfork_stub.o")
+message(STATUS "DEBUG: PTHREAD_STUB path = '${PTHREAD_STUB}'")
+message(STATUS "DEBUG: Checking if file exists: ${PTHREAD_STUB}")
+if(EXISTS "${PTHREAD_STUB}")
+  message(STATUS "✓ Linking pthread_atfork stub: ${PTHREAD_STUB}")
+  target_link_libraries(zig2 PRIVATE "${PTHREAD_STUB}")
+else()
+  message(WARNING "✗ pthread_atfork stub not found at: ${PTHREAD_STUB}")
+endif()
+
 if(MSVC)
   target_link_libraries(zig2 LINK_PUBLIC ntdll.lib ws2_32.lib)
