{% set name = "zig" %}
{% set version = "0.13.0" %}
{% set llvm_version = "18" %}

package:
  name: {{ name|lower }}
  version: {{ version }}

source:
  - url: https://github.com/ziglang/zig/archive/refs/tags/{{ version }}.tar.gz
    sha256: d3912858003e340f315224bf177d0f441d86b81f62854f5c141b6d51ab6b5516
  # - url: https://github.com/ziglang/zig/archive/refs/heads/master.zip
  #   sha256: 535092b882cc5d64a2d07b3fe328cb15276eb2dfd87a5dfee8276c3d11f2f587
    patches:
      - patches/0001-cross-findllvm.patch  # [linux and (aarch64 or ppc64le)]
      - patches/0002-cross-CMakeLists.txt.patch  # [build_platform != target_platform]
      - patches/0003-cross-install.cmake.patch  # [build_platform != target_platform]
      - patches/0004-cross-ppc64le-signal.h.patch  # [ppc64le]
      # May be combined into a single patch once the build is found robust (few versions of zig)
      - patches/0001-win-set-MD-CMakeLists.txt.patch  # [win]
      - patches/0002-win-deprecations.patch  # [win]
      - patches/0003-win-LLVM_LIBRARIES-CMakeLists.txt.patch  # [win]
      - patches/0004-win-ZIG2_LINK_FLAGS-CMakeLists.txt.patch  # [win]
      - patches/0005-win-ZIG_BUILD_ARGS-CMakeLists.txt.patch  # [win]
      - patches/0006-win-add-libdir-build.zig.patch  # [win]
    folder: zig-source

  # We may need to use the upstream binary dist if conda ZIG cannot build a newer version
  # The zig variable in the build scripts would then need to be updated
  #
  # - folder: zig-bootstrap
  #   url: https://ziglang.org/download/{{ version }}/zig-windows-x86_64-{{ version }}.zip  # [win]
  #   sha256: d859994725ef9402381e557c60bb57497215682e355204d754ee3df75ee3c158  # [win]
  #   url: https://ziglang.org/download/{{ version }}/zig-macos-x86_64-{{ version }}.tar.xz  # [osx]
  #   sha256: 8b06ed1091b2269b700b3b07f8e3be3b833000841bae5aa6a09b1a8b4773effd  # [osx]
  #   url: https://ziglang.org/download/{{ version }}/zig-linux-x86_64-{{ version }}.tar.xz  # [linux]
  #   sha256: d45312e61ebcc48032b77bc4cf7fd6915c11fa16e4aad116b66c9468211230ea  # [linux]

build:
  number: 5
  skip: true  # [not linux and not ppc64le]
  script_env:
    - BUILD_WITH_CMAKE=1  # [(linux or osx or win) and x86_64]
  ignore_run_exports:
    - __glibc  # [linux and aarch64]
    - ucrt  # [win]
    - vc14_runtime  # [win]

requirements:
  build:
    - {{ compiler('c') }}
    - {{ compiler('cxx') }}
    - {{ c_stdlib }}_{{ build_platform }} >={{ c_stdlib_version }}  # [linux and aarch64]
    - {{ stdlib("c") }}
    - cmake >=3.5
    - ninja
    # This is needed to build a qemu that intercepts the execve() call that zig2 emits
    - glib  # [linux and build_platform != target_platform]
    - sysroot_{{ build_platform }} >=2.28  # [linux and build_platform != target_platform]
    - sysroot_{{ target_platform }} >=2.28  # [linux and build_platform != target_platform]
    # - gcc_impl_linux-ppc64le  # [linux and ppc64le]
    # - make  # [linux and build_platform != target_platform]
    # - meson  # [linux and build_platform != target_platform]
    # - pkg-config  # [linux and build_platform != target_platform]
    # - sphinx  # [linux and build_platform != target_platform]
    # - sphinx-rtd-theme  # [linux and build_platform != target_platform]
    # - zlib  # [linux and build_platform != target_platform]
    - zig  # [build_platform != target_platform]
  host:
    - {{ compiler('cxx') }}  # [linux and build_platform != target_platform]
    - clangdev {{ llvm_version }}
    - libclang-cpp {{ llvm_version }}
    - libcxx {{ cxx_compiler_version }}  # [osx]
    - llvmdev {{ llvm_version }}
    - llvm {{ llvm_version }}
    - lld {{ llvm_version }}
    - sysroot_{{ target_platform }} >=2.28  # [linux and aarch64]
    - libxml2  # [win]
    - zlib
    - zstd
  run:
    - libxml2  # [linux and build_platform != target_platform]
    - sysroot_{{ target_platform }} >=2.28  # [linux and (aarch64 or ppc64le)]

test:
  requires:
    - patchelf  # [aarch64]
    - sysroot_{{ target_platform }} >=2.28  # [linux and (aarch64 or ppc64le)]
  commands:
    - test -f ${PREFIX}/bin/zig  # [unix]
    - test -f ${PREFIX}/lib/zig/c.zig  # [unix]
    - test -f ${PREFIX}/lib/zig/compiler_rt.zig  # [unix]
    - test -f ${PREFIX}/lib/zig/zig.h  # [unix]
    - if not exist %PREFIX%\\bin\\zig.exe exit 1  # [win]
    - if not exist %PREFIX%\\lib\\zig\\c.zig exit 1  # [win]
    - if not exist %PREFIX%\\lib\\zig\\compiler_rt.zig exit 1  # [win]
    - if not exist %PREFIX%\\lib\\zig\\zig.h exit 1  # [win]
    {% set lib_dirs = [
      "compiler", "compiler_rt", "docs", "include", "init", "libc",
      "libcxx", "libcxxabi", "libunwind", "std", "tsan"
    ] %}
    {% for lib_dir in lib_dirs %}
    - test -d ${PREFIX}/lib/zig/{{ lib_dir }}  # [not (osx and arm64 or win)]
    - if not exist %PREFIX%\\lib\\zig\\{{ lib_dir }} exit 1  # [win]
    {% endfor %}

    # Functionality tests
    - readelf -l ${PREFIX}/bin/zig  # [(aarch64 or ppc64le)]
    - patchelf --set-interpreter ${PREFIX}/aarch64-conda-linux-gnu/sysroot/lib64/ld-linux-aarch64.so.1 ${PREFIX}/bin/zig  # [aarch64]
    - readelf -l ${PREFIX}/bin/zig  # [(aarch64 or ppc64le)]
    - zig version
    - zig zen
    - zig init
    - zig test zig-source/test/behavior.zig  # [not win]
    # One test fails on windows: 838/1932 behavior.floatop.test.@log2 with vectors...FAIL (TestUnexpectedResult)
    - zig test zig-source/test/behavior.zig || true  # [win]
  source_files:
    - zig-source/test

about:
  home: https://ziglang.org/
  license: MIT
  license_family: MIT
  license_file: zig-source/LICENSE
  summary: Zig is a general-purpose programming language and toolchain for maintaining robust, optimal, and reusable software.
  description: |
    Zig is a general-purpose programming language and toolchain for maintaining robust, optimal, and reusable software.
    Robust: Behavior is correct even for edge cases such as out of memory.
    Optimal: Write programs the best way they can behave and perform.
    Reusable: The same code works in many environments which have different constraints.
    Maintainable: Precisely communicate intent to the compiler and other programmers. 
      The language imposes a low overhead to reading code and is resilient to changing requirements and environments.
  doc_url: https://ziglang.org/documentation/{{ version }}/
  dev_url: https://github.com/ziglang/zig

extra:
  recipe-maintainers:
    - MementoRC
    - xmnlab
