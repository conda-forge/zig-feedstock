schema_version: 1

context:
  name: zig
  version: 0.15.2
  llvm_version: "20"

package:
  name: ${{ name|lower }}
  version: ${{ version }}

source:
  - url: https://github.com/ziglang/zig/archive/refs/tags/${{ version }}.tar.gz
    sha256: ebe6eb7006f6bbb72e54bd25d0675f2794084909d63a95aa315f2dcf2af5fd99
    patches:
      # Only apply CMake patch when cross-compiling (Needed to set the config.h)
      - if: x86_64 or linux
        then:
          - patches/0001-x86-maxrss-CMakeLists.txt.patch
          - patches/0001-cross-findllvm.patch
          - patches/0002-cross-CMakeLists.txt.patch
          - patches/0003-cross-install.cmake.patch
      - if: ppc64le
        then:
          - patches/0001-ppc64le-no-lld-build.zig.patch
          - patches/0002-ppc64le-add-relocations-relocation.zig.patch
      - if: win
        then:
          # May be combined into a single patch once the build is found robust (few versions of zig)
          - patches/0001-win-deprecations.patch
          - patches/0002-win-libraries-CMakeLists.txt.patch
          - patches/0003-win-add-libdir-build.zig.patch
          - patches/0004-win-remove-ucrt-Lld.zig.patch
    target_directory: zig-source

  # Bootstrap fallback: Use upstream binary dist if conda ZIG cannot build a newer version
  # The zig variable in the build scripts would then need to be updated
  # Uncomment the following sections to enable bootstrap binaries:
  #
  # - folder: zig-bootstrap
  #   if: win
  #   url: https://ziglang.org/download/${{ version }}/zig-windows-x86_64-${{ version }}.zip
  #   sha256: ...
  #
  # - folder: zig-bootstrap
  #   if: osx
  #   url: https://ziglang.org/download/${{ version }}/zig-macos-x86_64-${{ version }}.tar.xz
  #   sha256: ...
  #
  # - folder: zig-bootstrap
  #   if: linux
  #   url: https://ziglang.org/download/${{ version }}/zig-linux-x86_64-${{ version }}.tar.xz
  #   sha256: ...

build:
  number: 1
  skip:
    - not (aarch64 or ppc64le)
  script:
    content:
      - if: unix
        then:
          - bash ${RECIPE_DIR}/build.sh
      - if: win
        then:
          # The bld.bat script handles Windows builds
          - call %RECIPE_DIR%\build.bat
    env:
      BUILD_WITH_CMAKE: ${{ "1" if x86_64 }}

requirements:
  build:
    - ${{ compiler('c') }}
    - ${{ compiler('cxx') }}
    - ${{ stdlib("c") }}
    - cmake >=3.5
    - ninja
    - if: arm64 or aarch64 or ppc64le
      then: zig
    - if: aarch64 or ppc64le
      then:
        - ${{ c_stdlib }}_${{ build_platform }} >=${{ c_stdlib_version }}
        - patchelf
    - if: ppc64le
      then:
        - clangdev ${{ llvm_version }}.*
        - libclang-cpp ${{ llvm_version }}.*
        - lld ${{ llvm_version }}.*
        - llvm ${{ llvm_version }}.*
        - llvmdev ${{ llvm_version }}.*
        - zlib
        - zstd
    - if: (build_platform != target_platform) and osx
      then: libxml2-devel
    - if: unix
      then: sed

  host:
    - if: aarch64 or ppc64le
      then:
        - ${{ compiler('cxx') }}
    - clangdev ${{ llvm_version }}.*
    - libclang-cpp ${{ llvm_version }}.*
    - if: osx
      then:
        - libcxx ${{ llvm_version }}.*
    - libxml2-devel
    - llvmdev ${{ llvm_version }}.*
    - llvm ${{ llvm_version }}.*
    - lld ${{ llvm_version }}.*
    - if: aarch64 or ppc64le
      then:
        - sysroot_${{ target_platform }} >=${{ c_stdlib_version }}
    - zlib
    - zstd

  run:
    - if: aarch64 or ppc64le
      then:
        - sysroot_${{ target_platform }} >=${{ c_stdlib_version }}

  ignore_run_exports:
    by_name:
      - if: win
        then:
          - ucrt
          - vc14_runtime

tests:
  # Package contents verification
  - package_contents:
      bin:
        - zig
      files:
        - lib/zig/c.zig
        - lib/zig/compiler_rt.zig
        - lib/zig/zig.h
        - if: not (osx and arm64)
          then:
            - lib/zig/compiler/**
            - lib/zig/compiler_rt/**
            - lib/zig/docs/**
            - lib/zig/include/**
            - lib/zig/init/**
            - lib/zig/libc/**
            - lib/zig/libcxx/**
            - lib/zig/libcxxabi/**
            - lib/zig/libunwind/**
            - lib/zig/std/**

  # Functional tests
  - requirements:
      run:
        - if: linux and aarch64
          then:
            - patchelf
        - if: aarch64 or ppc64le
          then:
            - sysroot_${{ target_platform }} >=${{ c_stdlib_version }}

    files:
      source:
        - zig-source/test

    script:
      # Functionality tests
      # - if: aarch64
      #   then:
      #     - patchelf --set-interpreter ${PREFIX}/aarch64-conda-linux-gnu/sysroot/lib64/ld-${{ c_stdlib_version }}.so ${PREFIX}/bin/zig
      # - if: ppc64le
      #   then:
      #     - patchelf --set-interpreter ${PREFIX}/poweroc64le-conda-linux-gnu/sysroot/lib64/ld-${{ c_stdlib_version }}.so ${PREFIX}/bin/zig
      - if: aarch64 or ppc64le
        then:
          - readelf -l ${PREFIX}/bin/zig
          # - ldd ${PREFIX}/bin/zig

      - zig version
      - zig zen
      # - zig init

      - if: not win
        then:
          - zig test zig-source/test/behavior.zig
      # One test fails on windows: 838/1932 behavior.floatop.test.@log2 with vectors...FAIL (TestUnexpectedResult)
      - if: win
        then:
          - zig test zig-source/test/behavior.zig || true

about:
  homepage: https://ziglang.org/
  license: MIT
  license_file: zig-source/LICENSE
  summary: Zig is a general-purpose programming language and toolchain for maintaining robust, optimal, and reusable software.
  description: |
    Zig is a general-purpose programming language and toolchain for maintaining robust, optimal, and reusable software.
    Robust: Behavior is correct even for edge cases such as out of memory.
    Optimal: Write programs the best way they can behave and perform.
    Reusable: The same code works in many environments which have different constraints.
    Maintainable: Precisely communicate intent to the compiler and other programmers.
      The language imposes a low overhead to reading code and is resilient to changing requirements and environments.
  documentation: https://ziglang.org/documentation/${{ version }}/
  repository: https://github.com/ziglang/zig

extra:
  recipe-maintainers:
    - MementoRC
    - xmnlab
    - tdejager
